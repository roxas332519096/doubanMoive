<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name=referrer content=never>
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>豆瓣电影</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="//at.alicdn.com/t/font_724092_q6pgyevhbc.js"></script>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/main.css">
</head>
<body>
    <main>
        <section class="top active">
            <div class="top250">

            </div>
            <div class="loading">正在加载页面中....</div>
        </section>
        <section>2</section>
        <section>3</section>
    </main>
    <footer>
        <div class="button active">
            <svg class="icon" aria-hidden="true">
                <use xlink:href="#icon-top02"></use>
            </svg>
        </div>
        <div class="button">
            <svg class="icon" aria-hidden="true">
                <use xlink:href="#icon-wukuangeagleeye"></use>
            </svg>
        </div>
        <div class="button">
            <svg class="icon" aria-hidden="true">
                <use xlink:href="#icon-sousuo"></use>
            </svg>
        </div>
    </footer>
    <script src="./js/button.js"></script>
    <script>
        var index = 0;
        var isLoading = false;
        getData();
        function getData(){
            if(isLoading) return
            isLoading = true;
            console.log('loading动画出现')
            $('section.top > div.loading').addClass('active');
            $.ajax({
            url:'https://api.douban.com/v2/movie/top250',
            type:'GET',
            data:{
                start:index,
                count:20
            },
            dataType:'jsonp'
        }).done(function(respone){
            setData(respone);
            index += 20;
        }).fail(function(){
            console.log('error');
        }).always(function(){
            isLoading = false;
            console.log('loading动画消失')
            $('section.top > div.loading').removeClass('active');
        })
        }
        function setData(respone){
            respone.subjects.forEach(function(movie){
                let template = `
                <div class="item">
                    <a href="#">
                        <div class="cover">
                            <img src="__src__" alt="">
                        </div>
                        <div class="detail">
                            <h2>__title__</h2>
                            <div class="extra">__average__ / __collectcount__</div>
                            <div class="extra">__year__ / __genres1__  / __genres2__</div>
                            <div class="extra">导演:__directors__</div>
                            <div class="extra">主演:__cast1__ __cast2__ __cast3__</div>
                        </div>
                    </a>
                </div>
                `
                let html = template;
                // let src = 'https://images.weserv.nl/?url=' + movie.images.small.slice(6)
                let moviedata = {
                    src : movie.images.small,
                    title : movie.title,
                    average : movie.rating.average,
                    collectcount : movie.collect_count,
                    year : movie.year,
                    genres1 : movie.genres[0],
                    genres2 : movie.genres[1],
                    directors : movie.directors[0].name,
                    cast1 : movie.casts[0].name,
                    cast2 : movie.casts[1].name,
                    cast3 : movie.casts[2].name
                }
                let placeholers = 
                    ['src','title','average',
                    'collectcount','year','genres1','genres2',
                    'directors','cast1','cast2','cast3'
                    ]
                placeholers.map((string)=>{
                    html = html.replace(`__${string}__`,moviedata[string] || '');
                })
                $('.top250').append(html);
            });
        }
    </script>
    <script>
        $('main').scroll(function(){
            let sectionTop =  $('section.top').height();
            let currentTop = $('main').height() + $('main').scrollTop();
            if(sectionTop - 10 <= currentTop){
                getData();
            }
        })
    </script>
</body>
</html>